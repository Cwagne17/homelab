---
icon: material/cog-outline
---

# Talos Configuration

Understanding and customizing Talos machine configurations.

## Machine Configuration

Talos uses declarative YAML configuration for all machine settings. Our deployment uses configuration patches applied via OpenTofu.

## Configuration Structure

### Control Plane Config

Located at: `terraform/modules/talos_cluster/config/controlplane.yaml.tftpl`

Key sections:

```yaml
machine:
  network:
    hostname: ${hostname}
    interfaces:
      - interface: eth0
        dhcp: true
        addresses:
          - ${ip_cidr}
        routes:
          - network: 0.0.0.0/0
            gateway: ${gateway}
            metric: 1024
  nodeLabels:
    topology.kubernetes.io/region: home
    topology.kubernetes.io/zone: proxmox
    node.kubernetes.io/instance-type: control-plane

cluster:
  allowSchedulingOnControlPlanes: true
  network:
    cni:
      name: none # CNI managed separately
```

### Worker Config

Located at: `terraform/modules/talos_cluster/config/worker.yaml.tftpl`

Similar structure but without cluster-level configuration:

```yaml
machine:
  network:
    hostname: ${hostname}
    interfaces:
      - interface: eth0
        dhcp: true
        addresses:
          - ${ip_cidr}
  nodeLabels:
    node.kubernetes.io/instance-type: worker
```

## Customization Options

### Network Configuration

Modify network settings in the templates:

**Static Only (No DHCP)**

```yaml
interfaces:
  - interface: eth0
    addresses:
      - 10.23.45.30/24
    routes:
      - network: 0.0.0.0/0
        gateway: 10.23.45.1
```

**Multiple Interfaces**

```yaml
interfaces:
  - interface: eth0
    dhcp: true
  - interface: eth1
    addresses:
      - 192.168.100.10/24
```

### Node Labels

Add custom labels for scheduling:

```yaml
nodeLabels:
  topology.kubernetes.io/region: home
  topology.kubernetes.io/zone: proxmox
  workload-type: database
  storage: nvme
```

### Resource Limits

Configure kubelet limits:

```yaml
machine:
  kubelet:
    extraArgs:
      max-pods: "110"
    nodeIP:
      validSubnets:
        - 10.23.45.0/24
```

### Extensions

Talos Image Factory allows adding extensions. Current extensions:

- `siderolabs/qemu-guest-agent`: Proxmox integration

To add more extensions, update the image URL in `terraform/modules/talos_cluster/image.tf`.

### System Settings

Tune kernel parameters:

```yaml
machine:
  sysctls:
    net.core.somaxconn: "65535"
    net.ipv4.ip_forward: "1"
```

## Configuration Validation

Before applying changes, validate configuration:

```bash
talosctl validate --config output/talosconfig --mode cloud
```

## Applying Configuration Changes

### Method 1: OpenTofu

Modify templates and re-apply:

```bash
cd terraform/envs/talos_cluster
tofu apply
```

### Method 2: talosctl

For live changes without full redeployment:

```bash
# Edit config
talosctl -n 10.23.45.30 edit mc --mode=no-reboot

# Apply after editing
talosctl -n 10.23.45.30 apply-config --file modified-config.yaml
```

## Configuration Files

### Talosconfig

Client configuration for talosctl:

- **Location**: `output/talosconfig`
- **Contents**: Cluster endpoint, certificates, nodes
- **Usage**: `talosctl --talosconfig output/talosconfig ...`

### Machine Configurations

Generated by OpenTofu:

- Control plane: Applied to nodes with role `controlplane`
- Worker: Applied to nodes with role `worker`

## Security Considerations

### Secrets Management

Talos generates secrets automatically:

- Kubernetes CA certificates
- Service account keys
- Bootstrap tokens
- etcd encryption keys

These are stored in OpenTofu state (encrypted in S3).

### Network Policies

Talos enforces minimal network rules by default. Add custom policies via machine config:

```yaml
machine:
  network:
    kubespan:
      enabled: true # Encrypted node-to-node communication
```

## Best Practices

1. **Version Control**: Keep config templates in Git
2. **Immutable Changes**: Prefer full redeployment over live edits
3. **Test First**: Validate configs before applying
4. **Backup State**: Ensure OpenTofu state is backed up
5. **Document Changes**: Comment complex configurations

## Advanced Configuration

### Control Plane HA

For production, deploy multiple control plane nodes:

```hcl
nodes = {
  "k8s-cp00" = { role = "controlplane", ... }
  "k8s-cp01" = { role = "controlplane", ... }
  "k8s-cp02" = { role = "controlplane", ... }
}
```

### Custom CNI

Install Cilium or Calico:

```yaml
cluster:
  network:
    cni:
      name: none

  inlineManifests:
    - name: cilium
      contents: |
        # Cilium manifests here
```

### Additional Volumes

Mount extra disks:

```yaml
machine:
  disks:
    - device: /dev/sdb
      partitions:
        - mountpoint: /var/mnt/storage
```

## Reference

- [Talos Configuration Reference](https://www.talos.dev/latest/reference/configuration/)
- [Machine Config Patches](https://www.talos.dev/latest/talos-guides/configuration/patching/)
- [Network Configuration](https://www.talos.dev/latest/talos-guides/network/)
