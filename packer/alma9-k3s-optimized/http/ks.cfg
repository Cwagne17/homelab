# =============================================================================
# AlmaLinux 9 Kickstart Configuration
#
# Unattended installation for k3s-optimized golden image.
# Served via Packer's HTTP server during image build.
#
# What this configures:
#   - UEFI boot with GPT partitioning
#   - Minimal package selection with essential tools
#   - Root password for Packer provisioning
#   - Network configuration via DHCP
#   - Timezone and locale settings
#   - Cloud-init for post-deployment configuration
#
# Refs: Req 1.1, 1.3
# =============================================================================

# -----------------------------------------------------------------------------
# Installation Method
# -----------------------------------------------------------------------------

# Use graphical installation (required for some options)
text

# Accept EULA
eula --agreed

# Reboot after installation
reboot --eject

# -----------------------------------------------------------------------------
# Localization
# -----------------------------------------------------------------------------

# System language
lang en_US.UTF-8

# Keyboard layout
keyboard --vckeymap=us --xlayouts='us'

# Timezone (UTC for consistency; change via cloud-init if needed)
timezone UTC --utc

# -----------------------------------------------------------------------------
# Network Configuration
# -----------------------------------------------------------------------------

# Configure network via DHCP (static IP set by cloud-init post-deployment)
network --bootproto=dhcp --device=link --activate --onboot=yes
network --hostname=localhost.localdomain

# -----------------------------------------------------------------------------
# Installation Source
# -----------------------------------------------------------------------------

# Use CDROM as installation source
cdrom

# -----------------------------------------------------------------------------
# Security
# -----------------------------------------------------------------------------

# Root password for Packer provisioning
# SECURITY WARNING: This password is only used during image building.
# VMs cloned from this template use cloud-init SSH keys, not this password.
# The template should not be used directly without cloud-init configuration.
# TODO: Consider using --iscrypted with a hashed password for production
rootpw --plaintext packer

# Disable firewall during build (configure post-build if needed)
firewall --disabled

# SELinux in enforcing mode
selinux --enforcing

# Disable first boot setup agent
firstboot --disabled

# -----------------------------------------------------------------------------
# Partitioning (UEFI/GPT)
# -----------------------------------------------------------------------------

# Clear all partitions
zerombr
clearpart --all --initlabel

# Automatic partitioning with LVM
# EFI System Partition required for UEFI boot
autopart --type=lvm --fstype=xfs

# Bootloader configuration for UEFI
bootloader --location=boot --append="crashkernel=auto"

# -----------------------------------------------------------------------------
# Package Selection
# -----------------------------------------------------------------------------

%packages --ignoremissing
# Core system
@core
@base

# Essential tools
bash-completion
curl
wget
vim-enhanced
tar
unzip
openssh-server
openssh-clients
sudo

# System management
dnf-plugins-core
chrony
rsync

# Cloud-init for VM initialization
cloud-init
cloud-utils-growpart

# Python (for Ansible and system automation)
python3
python3-pip

# Kernel modules for networking
kernel-modules-extra

# Exclude unnecessary packages
-plymouth
-plymouth-core-libs
-plymouth-scripts
-iwl*firmware
%end

# -----------------------------------------------------------------------------
# Post-Installation Scripts
# -----------------------------------------------------------------------------

%post --log=/root/ks-post.log

# Enable essential services
systemctl enable sshd
systemctl enable chronyd
systemctl enable cloud-init
systemctl enable cloud-init-local
systemctl enable cloud-config
systemctl enable cloud-final

# Configure SSH for Packer provisioning
sed -i 's/^#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
sed -i 's/^PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

# Ensure cloud-init doesn't regenerate SSH keys on first boot
# (we'll regenerate them per-instance)
rm -f /etc/ssh/ssh_host_*

# Clean dnf cache
dnf clean all

# Log completion
echo "Kickstart post-install completed at $(date)" >> /root/ks-post.log

%end

# -----------------------------------------------------------------------------
# End of Kickstart
# -----------------------------------------------------------------------------
